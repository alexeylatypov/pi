<?php
/**
* NOTE: Parallel Thread class
*
* Get and run function in background
*
* Notes:
*
* 
**/
class ParallelThread extends Threaded {

	
	
    public function __construct(Closure $closure, array $args = []) {
        $this->closure = $closure;
        $this->args    = $args;
		$this->time_start = microtime(true);
		
    }
	
	
	
    public function run() {
        $closure = $this->closure;
        $this->synchronized(function() use($closure) {
            $this->result = $closure(...$this->args);
			echo json_encode(array( 'duration' => microtime(true)-$this->time_start, 'results' => $this->result, 'start_time' => $this->time_start))."<BR>";
            $this->notify();
       });
    }
    public function getResult() {
        return $this->synchronized(function(){
            while (!$this->result)
                $this->wait();
			echo json_encode(array( 'duration' => microtime(true)-$this->time_start, 'results' => $this->result, 'threadId' =>$this->getThreadId(), 'start_time' => $this->time_start))."<BR>";
			return json_encode(array( 'duration' => microtime(true)-$this->time_start, 'results' => $this->result, 'threadId' =>$this->getThreadId(), 'start_time' => $this->time_start));
       });
    }
    
	public static function add(Closure $closure, array $args = []) {
        $newthread = 
            new self($closure, $args);
        $newthread->start();
        return $newthread;
    }

	
    protected $closure;
    protected $args;
	protected $result;
	protected $time_start;

}


?>